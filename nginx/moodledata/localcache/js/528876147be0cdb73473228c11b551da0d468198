/**
 * Collapsed Topics Information
 *
 * A topic based format that solves the issue of the 'Scroll of Death' when a course has many topics. All topics
 * except zero have a toggle that displays that topic. One or more topics can be displayed at any given time.
 * Toggles are persistent on a per browser session per course basis but can be made to persist longer by a small
 * code change. Full installation instructions, code adaptions and credits are included in the 'Readme.txt' file.
 *
 * @package    format_topcoll
 * @version    See the value of '$plugin->version' in version.php.
 * @copyright  &copy; 2009-onwards G J Barnard in respect to modifications of standard topics format.
 * @author     G J Barnard - gjbarnard at gmail dot com and {@link http://moodle.org/user/profile.php?id=442195}
 * @link       http://docs.moodle.org/en/Collapsed_Topics_course_format
 * @license    http://www.gnu.org/copyleft/gpl.html GNU Public License
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.

 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.

 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
M.format_topcoll=M.format_topcoll||{};M.format_topcoll.thesparezeros="00000000000000000000000000";M.format_topcoll.togglestate=!1;M.format_topcoll.courseid=0;M.format_topcoll.togglePersistence=1;M.format_topcoll.ourYUI=!1;M.format_topcoll.numSections=0;M.format_topcoll.oneTopic=!1;M.format_topcoll.currentTopic=null;M.format_topcoll.currentTopicNum=!1;M.format_topcoll.userIsEditing=!1;M.format_topcoll.TOGGLE_6=1;M.format_topcoll.TOGGLE_5=2;M.format_topcoll.TOGGLE_4=4;M.format_topcoll.TOGGLE_3=8;M.format_topcoll.TOGGLE_2=16;M.format_topcoll.TOGGLE_1=32;M.format_topcoll.init=function(Y,theCourseId,theToggleState,theNumSections,theTogglePersistence,theDefaultTogglePersistence,theOneTopic,theOneTopicToggle,theUserIsEditing){"use strict";this.ourYUI=Y;this.courseid=theCourseId;this.togglestate=theToggleState;this.numSections=parseInt(theNumSections);this.togglePersistence=theTogglePersistence;this.oneTopic=theOneTopic;this.userIsEditing=theUserIsEditing;if((this.togglestate!==null)&&(this.togglePersistence==1)){if(this.is_old_preference(this.togglestate)===!0){this.convert_to_new_preference()}
var numdigits=this.get_required_digits(this.numSections);if(numdigits>this.togglestate.length){var dchar;if(theDefaultTogglePersistence===0){dchar=this.get_min_digit()}else{dchar=this.get_max_digit()}
for(var i=this.togglestate.length;i<numdigits;i++){this.togglestate+=dchar}}else if(numdigits<this.togglestate.length){this.togglestate=this.togglestate.substring(0,numdigits)}}else{if(theDefaultTogglePersistence===0){this.resetState(this.get_min_digit())}else{this.resetState(this.get_max_digit())}}
var toggleHeight=!1;for(var togi=1;togi<=this.numSections;togi++){var toggle=Y.one("ul.ctopics #toggle-"+togi);if(toggle){toggle.on('click',this.toggleClick,this);toggle.on('key',this.toggleClick,'enter',this);if(toggleHeight===!1){toggleHeight=toggle.get('offsetHeight')}}}
if(this.oneTopic===!1){var allopen=Y.one("#toggles-all-opened");if(allopen){allopen.on('click',this.allOpenClick);allopen.on('key',this.allOpenClick,'enter')}
var allclosed=Y.one("#toggles-all-closed");if(allclosed){allclosed.on('click',this.allCloseClick);allclosed.on('key',this.allCloseClick,'enter')}}else{if(theOneTopicToggle!==!1){this.currentTopic=Y.one("ul.ctopics #toggle-"+theOneTopicToggle);this.currentTopicNum=theOneTopicToggle}}
if(toggleHeight!==!1){var topcollShiftWindow=function(){if(location.hash.startsWith('#section-')){scrollBy(0,-toggleHeight)}};if(location.hash){topcollShiftWindow()}
window.addEventListener("hashchange",topcollShiftWindow)}};M.format_topcoll.toggleClick=function(e){if(this.userIsEditing){var parentClasses=e.target.get('parentNode').getAttribute('class');if((parentClasses.indexOf('quickediticon')>-1)||(parentClasses.indexOf('inplaceeditable')>-1)){return}}
var toggleIndex=parseInt(e.currentTarget.get('id').replace("toggle-",""));e.preventDefault();this.toggle_topic(e.currentTarget,toggleIndex)};M.format_topcoll.allOpenClick=function(e){e.preventDefault();M.format_topcoll.ourYUI.all(".toggledsection").addClass('sectionopen');M.format_topcoll.ourYUI.all(".toggle span.the_toggle").addClass('toggle_open').removeClass('toggle_closed').setAttribute('aria-expanded','true');M.format_topcoll.resetState(M.format_topcoll.get_max_digit());M.format_topcoll.save_toggles()};M.format_topcoll.allCloseClick=function(e){e.preventDefault();M.format_topcoll.ourYUI.all(".toggledsection").removeClass('sectionopen');M.format_topcoll.ourYUI.all(".toggle span.the_toggle").addClass('toggle_closed').removeClass('toggle_open').setAttribute('aria-expanded','false');M.format_topcoll.resetState(M.format_topcoll.get_min_digit());M.format_topcoll.save_toggles()};M.format_topcoll.resetState=function(dchar){M.format_topcoll.togglestate="";var numdigits=M.format_topcoll.get_required_digits(M.format_topcoll.numSections);for(var i=0;i<numdigits;i++){M.format_topcoll.togglestate+=dchar}};M.format_topcoll.toggle_topic=function(targetNode,toggleNum){"use strict";if(this.oneTopic===!0){if((this.currentTopicNum!==!1)&&(this.currentTopicNum!=toggleNum)){var currentTarget=this.currentTopic.one('span.the_toggle');currentTarget.addClass('toggle_closed').removeClass('toggle_open').setAttribute('aria-expanded','false');this.currentTopic.next('.toggledsection').removeClass('sectionopen');this.set_toggle_state(this.currentTopicNum,!1);this.currentTopic=null;this.currentTopicNum=!1}}
var target=targetNode.one('span.the_toggle');var state;if(!target.hasClass('toggle_open')){target.addClass('toggle_open').removeClass('toggle_closed').setAttribute('aria-expanded','true');targetNode.next('.toggledsection').addClass('sectionopen');state=!0;if(this.oneTopic===!0){this.currentTopic=targetNode;this.currentTopicNum=toggleNum}}else{target.addClass('toggle_closed').removeClass('toggle_open').setAttribute('aria-expanded','false');targetNode.next('.toggledsection').removeClass('sectionopen');state=!1;if(this.oneTopic===!0){this.currentTopic=null;this.currentTopicNum=!1}}
this.set_toggle_state(toggleNum,state);this.save_toggles()};M.format_topcoll.to2baseString=function(thirtysix){"use strict";var firstpart=parseInt(thirtysix.substring(0,6),36);var secondpart=parseInt(thirtysix.substring(6,12),36);var fps=firstpart.toString(2);var sps=secondpart.toString(2);if(fps.length<26){fps=this.thesparezeros.substring(0,(26-fps.length))+fps}
if(sps.length<27){sps=this.thesparezeros.substring(0,(27-sps.length))+sps}
return fps+sps};M.format_topcoll.save_toggles=function(){"use strict";if(this.togglePersistence==1){M.format_topcoll.set_user_preference('topcoll_toggle_'+this.courseid,this.togglestate)}};M.format_topcoll.is_old_preference=function(pref){"use strict";var retr=!1;var firstchar=pref[0];if((firstchar=='0')||(firstchar=='1')){retr=!0}
return retr};M.format_topcoll.convert_to_new_preference=function(){"use strict";var toggleBinary=this.to2baseString(this.togglestate);var bin,value;this.togglestate="";var logbintext="";for(var i=1;i<=43;i=i+6){bin=toggleBinary.substring(i,i+6);value=parseInt(bin,2);this.togglestate+=this.encode_value_to_character(value);logbintext+=bin+' '}
bin=toggleBinary.substring(49,53);logbintext+=bin+' ';value=parseInt(bin,2);value=value<<2;this.togglestate+=this.encode_value_to_character(value)};M.format_topcoll.set_toggle_state=function(togglenum,state){"use strict";var togglecharpos=this.get_toggle_pos(togglenum);var toggleflag=this.get_toggle_flag(togglenum,togglecharpos);var value=this.decode_character_to_value(this.togglestate.charAt(togglecharpos-1));if(state===!0){value|=toggleflag}else{value&=~toggleflag}
var newchar=this.encode_value_to_character(value);var start=this.togglestate.substring(0,togglecharpos-1);var end=this.togglestate.substring(togglecharpos);this.togglestate=start+newchar+end};M.format_topcoll.get_required_digits=function(numtoggles){"use strict";return this.get_toggle_pos(numtoggles)};M.format_topcoll.get_toggle_pos=function(togglenum){"use strict";return Math.ceil(togglenum/6)};M.format_topcoll.get_min_digit=function(){"use strict";return':'};M.format_topcoll.get_max_digit=function(){"use strict";return'y'};M.format_topcoll.get_toggle_flag=function(togglenum,togglecharpos){"use strict";var toggleflagpos=togglenum-((togglecharpos-1)*6);var flag;switch(toggleflagpos){case 1:flag=this.TOGGLE_1;break;case 2:flag=this.TOGGLE_2;break;case 3:flag=this.TOGGLE_3;break;case 4:flag=this.TOGGLE_4;break;case 5:flag=this.TOGGLE_5;break;case 6:flag=this.TOGGLE_6;break}
return flag};M.format_topcoll.decode_character_to_value=function(character){"use strict";return character.charCodeAt(0)-58};M.format_topcoll.encode_value_to_character=function(val){"use strict";return String.fromCharCode(val+58)};M.format_topcoll.set_user_preference=function(name,value){YUI().use('io',function(Y){var url=M.cfg.wwwroot+'/course/format/topcoll/settopcollpref.php?sesskey='+M.cfg.sesskey+'&pref='+encodeURI(name)+'&value='+encodeURI(value);var cfg={method:'get',on:{}};if(M.cfg.developerdebug){cfg.on.failure=function(){console.log("Error updating topcoll preference '"+name+"' using AJAX.  Almost certainly your session has timed out.  Clicking this link will repeat the AJAX call that failed so you can see the error: ")}}
Y.io(url,cfg)})}