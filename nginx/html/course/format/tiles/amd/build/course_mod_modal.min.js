function _typeof(a){"@babel/helpers - typeof";if("function"==typeof Symbol&&"symbol"==typeof Symbol.iterator){_typeof=function(a){return typeof a}}else{_typeof=function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a}}return _typeof(a)}define ("format_tiles/course_mod_modal",["jquery","core/modal_factory","core/config","core/templates","core/notification","core/ajax"],function(a,b,c,d,f,g){"use strict";var h={},i,j=a(window),k,l={completioncheckbox:".completioncheckbox",completionAuto:".completion-auto",modal:".modal",modalDialog:".modal-dialog",modalBody:".modal-body",sectionMain:".section.main",pageContent:"#page-content",regionMain:"#region-main",completionState:"#completion-check-",cmModalClose:".embed_cm_modal .close",cmModal:".embed_cm_modal",moodleMediaPlayer:".mediaplugin_videojs",urlModalLoadWarning:"#embed-url-error-msg-",closeBtn:"button.close",ACTIVITY:"li.activity",URLACTIVITYPOPUPLINK:".activity.modtype_url.urlpopup a",newWindowButton:".button_expand",modalHeader:".modal-header",embedModuleButtons:".embed-module-buttons",iframe:"iframe"},m={COMPLETION_MANUAL:"completeonmanual",COMPLETION_AUTO:"completion-auto"},n={launchResourceModal:"launch-tiles-resource-modal",launchModuleModal:"launch-tiles-module-modal",launchUrlModal:"launch-tiles-url-modal"},o=function(){return Math.min(j.width(),1100)},p=function(b){var c=b.find(l.iframe);if(0<c.length){b.find(l.closeBtn).click(function(b){a(b.currentTarget).closest(l.cmModal).find(l.iframe).each(function(b,c){c=a(c);c.attr("src",c.attr("src"))})})}var d=b.find("object");if(0<d.length){b.find(l.closeBtn).click(function(b){var c=a(b.currentTarget).closest(l.cmModal);c.find("object").each(function(b,c){c=a(c);c.attr("data","")});h[c.attr("data-cmid")]=void 0})}var e=b.find(l.moodleMediaPlayer);if(0<e.length){b.find(l.closeBtn).click(function(){b.find(l.moodleMediaPlayer).html("")});h[b.attr("data-cmid")]=void 0}},q=function(e){var g=e.attr("data-cmid");b.create({type:b.types.DEFAULT,title:e.attr("data-title"),body:i}).done(function(b){h[g]=b;b.setLarge();b.show();var i=a(b.root);i.attr("id","embed_mod_modal_"+g);i.attr("data-cmid",g);i.addClass("embed_cm_modal");var k=e.closest(l.sectionMain).attr("data-section"),n={id:g,pluginfileUrl:e.attr("data-url"),objectType:"text/html",width:"100%",height:Math.round(j.height()-60),cmid:g,tileid:k,isediting:0,sesskey:c.sesskey,modtitle:e.attr("data-title"),config:{wwwroot:c.wwwroot},showDownload:0,showNewWindow:0,completionInUseForCm:0,completionstring:""};if("resource_pdf"===e.attr("data-modtype")){n.objectType="application/pdf";n.showDownload=1;n.showNewWindow=1}d.render("format_tiles/embed_file_modal_body",n).done(function(a){b.setBody(a);i.find(l.modalBody).animate({"min-height":Math.round(j.height()-60)},"fast");if("resource_html"===e.attr("data-modtype")){i.find(l.modal).animate({"max-width":"100%"},"fast");i.find(l.modalDialog).animate({"max-width":"100%"},"fast");i.find(l.modalBody).animate({"max-width":"100%"},"fast");p(i)}else{i.find(l.modal).animate({"max-width":o()},"fast");i.find(l.modalDialog).animate({"max-width":o()},"fast")}}).fail(f.exception);var q=e.find(l.completioncheckbox);if(0!==q.length){n.completionstate=e.hasClass(m.COMPLETION_AUTO)?1:parseInt(q.attr("data-completionstate"));n.completionInUseForCm=1;n.completionicon=1===n.completionstate?"y":"n";n.completionstateInverse=1-n.completionstate;n.completionIsManual=e.hasClass(m.COMPLETION_MANUAL);n.completionstring=q.attr("title");require(["format_tiles/completion"],function(a){a.triggerCompletionChangedEvent(k)})}d.render("format_tiles/embed_module_modal_header_btns",n).done(function(a){i.find(l.modalHeader).append(a);i.find(l.closeBtn).detach().appendTo(i.find(l.embedModuleButtons))}).fail(f.exception);return!0});return!1},r=function(e){var g=e.attr("data-cmid");b.create({type:b.types.DEFAULT,title:e.attr("data-title"),body:i}).done(function(b){h[g]=b;b.setLarge();b.show();var i=a(b.root);i.attr("id","embed_mod_modal_"+g);i.attr("data-cmid",g);i.addClass("embed_cm_modal");var k=Math.round(.9*j.width()),n=Math.round(.9*j.height()),o=e.closest(l.sectionMain).attr("data-section"),q={id:g,pluginfileUrl:e.attr("data-url"),objectType:"text/html",width:k-30,height:n-30,cmid:g,tileid:o,isediting:0,sesskey:c.sesskey,modtitle:e.attr("data-title"),config:{wwwroot:c.wwwroot},showDownload:0,showNewWindow:1,completionInUseForCm:0,secondaryurl:e.closest(l.ACTIVITY).attr("data-url-secondary")};d.render("format_tiles/embed_url_modal_body",q).done(function(a){b.setBody(a);i.find(l.modalBody).animate({"min-height":n},"fast");i.find(l.modal).animate({"max-width":k},"fast");i.find(l.modalDialog).animate({"max-width":k},"fast");i.find(l.modalBody).animate({"max-width":k},"fast");p(i);i.find(l.modalBody).addClass("text-center")}).fail(f.exception);var r=e.find(l.completioncheckbox);if(0!==r.length){q.completionstate=e.hasClass(m.COMPLETION_AUTO)?1:parseInt(r.attr("data-completionstate"));q.completionInUseForCm=1;q.completionicon=1===q.completionstate?"y":"n";q.completionstateInverse=1-q.completionstate;q.completionIsManual=e.hasClass(m.COMPLETION_MANUAL);q.completionstring=r.attr("title");require(["format_tiles/completion"],function(a){a.triggerCompletionChangedEvent(o)})}d.render("format_tiles/embed_module_modal_header_btns",q).done(function(a){i.find(l.modalHeader).append(a);i.find(l.closeBtn).detach().appendTo(i.find(l.embedModuleButtons))}).fail(f.exception);setTimeout(function(){i.find(l.newWindowButton).click(function(){h[i.attr("data-cmid")].hide();h[i.attr("data-cmid")]=void 0;i.remove();a(".modal-backdrop").not("#window-overlay").removeClass("show").addClass("hide")})},1e3);return!0});return!1},s=function(b){b.find(l.modal).animate({"max-width":o()},"fast");var c=a(l.moodleMediaPlayer);c.find("div").each(function(b,c){a(c).css("max-width","")});if(0<c.length){p(b)}b.find(l.iframe).each(function(c,d){var e=b.find(l.modalDialog);if(0===e.length){e=b.find(l.modal)}var f=Math.min(a(d).width(),j.width());if(f>e.width()-70){e.animate({"max-width":Math.max(f+70,o())},"fast");b.find(l.modal).animate({"max-width":Math.max(f+70,o())},"fast")}var g=Math.min(a(d).height(),j.height()),h=b.find(l.modalBody);if(g>h.height()-70){h.animate({"min-height":Math.min(g+70,j.height())+1},"fast")}p(b)})},t=function(a,b,c){var d=3<arguments.length&&arguments[3]!==void 0?arguments[3]:0,e=a.find(l.modalBody);if(e){var f=Math.round(e.height());if(f&&f>d+10){s(a)}if(0<b){setTimeout(function(){t(a,b-1,c,f)},c)}}},u=function(e){var j=e.attr("data-cmid"),n="format_tiles_get_mod_"+e.attr("data-modtype")+"_html";b.create({type:b.types.DEFAULT,title:e.attr("data-title"),body:i}).done(function(b){h[j]=b;b.setLarge();b.show();var i=a(b.root);i.attr("data-cmid",j);i.attr("id","embed_mod_modal_"+j);i.addClass("embed_cm_modal");i.addClass("mod_"+e.attr("data-modtype"));p(i);g.call([{methodname:n,args:{courseid:k,cmid:j}}])[0].done(function(a){var c=e.closest(l.sectionMain).attr("data-section"),g={cmid:j,modtitle:e.attr("data-title"),tileid:c,content:a.html},h=e.find(l.completioncheckbox);if(0!==h.length){g.completionstate=e.hasClass(m.COMPLETION_AUTO)?1:parseInt(h.attr("data-completionstate"));g.completionInUseForCm=1;g.completionicon=1===g.completionstate?"y":"n";g.completionstateInverse=1-g.completionstate;g.completionIsManual=e.hasClass(m.COMPLETION_MANUAL);g.completionstring=h.attr("title");require(["format_tiles/completion"],function(a){a.triggerCompletionChangedEvent(c)})}b.setBody(g.content);d.render("format_tiles/embed_module_modal_header_btns",g).done(function(a){i.find(l.modalHeader).append(a);i.find(l.closeBtn).detach().appendTo(i.find(l.embedModuleButtons))}).fail(f.exception);setTimeout(function(){t(i,3,1e3)},500);return!0}).fail(function(a){if(!0!==c.developerdebug){window.location=c.wwwroot+"/mod/"+e.attr("data-modtype")+"/view.php?id="+j}else{f.exception(a)}})});return!1},v=function(b){var c=a(b.currentTarget).closest(l.ACTIVITY);if(c.attr("data-url")!==void 0){b.stopPropagation();b.preventDefault();g.call([{methodname:"format_tiles_log_mod_view",args:{courseid:k,cmid:c.attr("data-cmid")}}])[0].done(function(){require(["format_tiles/completion"],function(a){a.markAsAutoCompleteInUI(k,c)});var a=window.open(c.attr("data-url"));try{a.focus()}catch(a){var b="<div><a href=\""+c.attr("data-url")+"\">"+c.attr("data-url")+"</a></div>";require(["core/str","core/notification"],function(a,c){a.get_strings([{key:"sectionerrortitle",component:"format_tiles"},{key:"blockedpopup",component:"format_tiles"},{key:"cancel"}]).done(function(a){c.alert(a[0],a[1]+b,a[2])})})}}).fail(f.exception)}};return{init:function init(b,c){k=b;a(document).ready(function(){var b=Object.keys(n).map(function(a){return"[data-action=\""+n[a]+"\"]"}).join(", "),e=a(l.pageContent);if(0===e.length){e=a(l.regionMain)}e.on("click",b,function(b){b.preventDefault();var c=a(b.currentTarget),d=c.closest("li.activity"),e=h[d.attr("data-cmid")];if("object"===_typeof(e)){e.show()}else{switch(c.attr("data-action")){case n.launchModuleModal:u(d);break;case n.launchResourceModal:q(d);break;case n.launchUrlModal:r(d);break;default:throw new Error("Unknown modal type "+c.attr("data-action"));}g.call([{methodname:"format_tiles_log_mod_view",args:{courseid:k,cmid:d.attr("data-cmid")}}])[0].fail(f.exception)}if(0!==d.find(l.completionAuto).length){require(["format_tiles/completion"],function(a){a.triggerCompletionChangedEvent(d.closest(l.sectionMain).attr("data-section"))})}});d.render("format_tiles/loading",{}).catch(f.exception).done(function(a){i=a}).fail(f.exception);if(!c){e.on("click",l.URLACTIVITYPOPUPLINK,function(a){v(a)})}})}}});
//# sourceMappingURL=course_mod_modal.min.js.map
