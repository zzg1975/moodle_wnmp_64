define ("format_tiles/completion",["jquery","core/templates","core/config","core/ajax","format_tiles/completion"],function(a,b,c,d){"use strict";var e,f={},g={cmid:"data-cmid",numberComplete:"data-numcomplete",numberOutOf:"data-numoutof",section:"data-section"},h={launchModuleModal:"[data-action=\"launch-tiles-module-modal\"]",launchResourceModal:"[data-action=\"launch-tiles-resource-modal\"]",pageContent:"#page-content",regionMain:"#region-main",resourceModule:".activity.resource",completeonevent:".completeonevent",completeonview:".completeonview",activity:"li.activity",section:"li.section.main",togglecompletion:"[data-action=\"change-completion-status\"]",tileId:"#tile-",progressIndicatorId:"#tileprogress-",tile:".tile",spacer:".spacer",availabilityinfo:".availabilityinfo",sectionId:"#section-"},i={completionYes:"completion-icon-y",completionNo:"completion-icon-n"},j=function(b,c,d,e){var f={tileid:b,numComplete:c,numOutOf:d,showAsPercent:e,percent:0<d?Math.round(100*(c/d)):0,percentCircumf:106.8,percentOffset:0<d?Math.round(106.8*((d-c)/d)):0,isComplete:!1,isSingleDigit:!1,hastilephoto:a(h.tileId+b).hasClass("phototile")};if(0===b){f.isOverall=1}else{f.isOverall=0}if(0<d&&c>=d){f.isComplete=!0}if(10>f.percent){f.isSingleDigit=!0}return f},k=function(a,c,d){if(0>d||d>c.attr(g.numberOutOf)){return}if(!a){return}b.render("format_tiles/progress",j(a,d,parseInt(c.attr(g.numberOutOf)),c.hasClass("percent"))).done(function(a){c.replaceWith(a)})},l=function(c,d){b.render("format_tiles/progress",j(0,c,d,!0)).done(function(b){a("#tileprogress-0").replaceWith(b).fadeOut(0).animate({opacity:1},500)})},m=function(b,c){d.call([{methodname:"format_tiles_update_activity_completion_status_manually",args:{cmid:b,completed:c}}])[0].done(function(d){if(d.status){var e=a("#module-"+b).closest(h.section).attr("data-section");if(e){o(e)}var f=a(h.togglecompletion+"[data-cmid=\""+b+"\"]");if(f){f.attr("data-state",c?"1":"0");if(c){f.find(".completion_img_"+b).addClass(i.completionYes).removeClass(i.completionNo)}else{f.find(".completion_img_"+b).addClass(i.completionNo).removeClass(i.completionYes)}}}}).fail(function(a){require(["core/log"],function(b){b.debug("Failed to set completion state");b.debug(a)})})},n=function markAsAutoCompleteInUI(b){var c=b.closest(h.section).attr("data-section");if(b.hasClass("completeonview")){var d=b.find(".completion-icon"),e=d.closest(".completioncheckbox");if("0"===e.attr("data-ismanual")&&"0"===e.attr("data-completionstate")){d.addClass(i.completionYes).removeClass(i.completionNo);e.attr("data-completionstate",1);e.attr("data-original-title",f.completeauto);var j=a(h.progressIndicatorId+c),m=Math.min(parseInt(j.attr(g.numberComplete))+1,j.attr(g.numberOutOf));k(c,j,m);var n=a("#tileprogress-0"),o=Math.min(parseInt(n.attr(g.numberComplete))+1,n.attr(g.numberOutOf));l(o,parseInt(n.attr(g.numberOutOf)))}}},o=function triggerCompletionChangedEvent(b){a(document).trigger("format-tiles-completion-changed",{section:parseInt(b)})},p=function updateSectionsInfo(c,d,e){c.forEach(function(c){var f=a(h.tileId+c.sectionnum);if(c.isavailable&&f.hasClass("tile-restricted")){f.removeClass("tile-restricted")}else if(!c.isavailable){f.addClass("tile-restricted")}if(c.isclickable&&!f.hasClass("tile-clickable")){f.addClass("tile-clickable")}else if(!c.isclickable&&f.hasClass("tile-clickable")){f.removeClass("tile-clickable")}var g=a(h.progressIndicatorId+c.sectionnum);k(c.sectionnum,g,c.numcomplete);l(d,e);var i=f.find(h.availabilityinfo);if(0<i.length&&c.isavailable&&!c.availabilitymessage){i.fadeOut()}else if(!c.isavailable&&c.availabilitymessage){if(0<i.length){i.html="NEW"+c.availabilitymessage;i.fadeIn()}else{b.render("format_tiles/availability_info",{availabilitymessage:c.availabilitymessage,visible:!0}).done(function(a){g.replaceWith(a)})}}})},q=function updateTileInformation(b){if(b===void 0){b=a(h.tile).not(h.spacer).map(function(b,c){return parseInt(a(c).attr("data-section"))}).toArray()}d.call([{methodname:"format_tiles_get_section_information",args:{courseid:e,sectionnums:b}}])[0].done(function(a){p(a.sections,a.overall.complete,a.overall.outof)}).fail(function(a){require(["core/log"],function(b){b.debug("Failed to get section information to check completion status of section");b.debug(a)})})};return{init:function init(b,c){e=b;a(document).ready(function(){f.completeauto=c;a("body").on("click",h.togglecompletion,function(b){b.preventDefault();var c=a(b.currentTarget);m(c.attr("data-cmid"),"1"!==c.attr("data-state"))});var b=a("#page-content");if(0===b.length){b=a("#region-main")}b.on("click",h.launchModuleModal+", "+h.launchResourceModal,function(b){var c=a(b.currentTarget).closest(h.activity);if(c.hasClass("completeonview")){n(c)}})})},markAsAutoCompleteInUI:function markAsAutoCompleteInUI(a,b){e=a;n(b)},triggerCompletionChangedEvent:function triggerCompletionChangedEvent(a){o(a)},updateTileInformation:function updateTileInformation(a){try{q(a)}catch(a){require(["core/log"],function(b){b.debug(a)})}},updateSectionsInfo:function updateSectionsInfo(a,b,c){p(a,b,c)}}});
//# sourceMappingURL=completion.min.js.map
