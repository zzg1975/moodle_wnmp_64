define ("format_tiles/completion",["jquery","core/templates","core/config","core/ajax","format_tiles/completion"],function(a,b,c,d){"use strict";var e,f={},g=!1,h={cmid:"data-cmid",numberComplete:"data-numcomplete",numberOutOf:"data-numoutof",section:"data-section"},i={launchModuleModal:"[data-action=\"launch-tiles-module-modal\"]",launchResourceModal:"[data-action=\"launch-tiles-resource-modal\"]",pageContent:"#page-content",regionMain:"#region-main",resourceModule:".activity.resource",completeonevent:".completeonevent",completeonview:".completeonview",activity:"li.activity",section:"li.section.main",togglecompletion:"form.togglecompletion",tileId:"#tile-",progressIndicatorId:"#tileprogress-",tile:".tile",spacer:".spacer",availabilityinfo:".availabilityinfo",sectionId:"#section-"},j={completionYes:"completion-icon-y",completionNo:"completion-icon-n"},k=[],l=function(b,c,d,e){var f={tileid:b,numComplete:c,numOutOf:d,showAsPercent:e,percent:Math.round(100*(c/d)),percentCircumf:106.8,percentOffset:Math.round(106.8*((d-c)/d)),isComplete:!1,isSingleDigit:!1,hastilephoto:a(i.tileId+b).hasClass("phototile")};if(0===b){f.isOverall=1}else{f.isOverall=0}if(c>=d){f.isComplete=!0}if(10>f.percent){f.isSingleDigit=!0}return f},m=function(c,d,e){if(0===d.attr(h.numberComplete)&&0>e){return}var f=Math.min(parseInt(d.attr(h.numberComplete))+e,d.attr(h.numberOutOf)),j=a("#tileprogress-0"),k=Math.min(parseInt(j.attr(h.numberComplete))+e,j.attr(h.numberOutOf));b.render("format_tiles/progress",l(c,f,d.attr(h.numberOutOf),d.hasClass("percent"))).done(function(b){d.replaceWith(b);if(g){try{a(i.progressIndicatorId+c).tooltip()}catch(a){require(["core/log"],function(b){b.debug(a)})}}});b.render("format_tiles/progress",l(0,k,j.attr(h.numberOutOf),!0)).done(function(b){a("#tileprogress-0").replaceWith(b).fadeOut(0).animate({opacity:1},500)})},n=function(b){var d=b.attr(h.cmid),f=a("#completionstate_"+d),l={id:d,completionstate:parseInt(f.attr("value")),fromajax:1,sesskey:c.sesskey};if(g){try{b.tooltip("hide")}catch(a){require(["core/log"],function(b){b.debug(a)})}}var n=c.wwwroot+"/course/togglecompletion.php";a.post(n,l,function(c,g){if("success"===g&&"OK"===c){var l,n=a(".completion_img_"+d);if("1"===f.attr("value")){a("#completion_dynamic_change").attr("value",0);f.attr("value",0);l=1;n.addClass(j.completionYes).removeClass(j.completionNo);a(".complete-y-"+d).fadeIn(200).fadeOut(1e3)}else{a("#completion_dynamic_change").attr("value",1);f.attr("value",1);l=-1;a(".complete-n-"+d).fadeIn(200).fadeOut(1e3);n.addClass(j.completionNo).removeClass(j.completionYes)}if(!f.closest(i.activity).is(k.map(function(a){return"."+a}).join(","))){m(b.attr(h.section),a(i.progressIndicatorId+b.attr(h.section)),l);require(["format_tiles/browser_storage"],function(a){a.storeCourseContent(e,b.attr("data-section"),"")})}}}).fail(function(){throw new Error("Failed to register completion change with server")})},o=function markAsAutoCompleteInUI(b){var c=b.closest(i.section).attr("data-section");if(b.hasClass("completeonview")){var d=b.find(".completion-icon"),h=d.closest(".completioncheckbox");if("0"===h.attr("data-ismanual")&&"0"===h.attr("data-completionstate")){d.addClass(j.completionYes).removeClass(j.completionNo);h.attr("data-completionstate",1);h.attr("data-original-title",f.completeauto);if(g){try{h.tooltip()}catch(a){require(["core/log"],function(b){b.debug(a)})}}m(c,a(i.progressIndicatorId+c),1)}}require(["format_tiles/browser_storage"],function(a){a.storeCourseContent(e,c,"")})},p=function updateTileInformation(c){if(c===void 0){c=a(i.tile).not(i.spacer).map(function(b,c){return parseInt(a(c).attr("data-section"))}).toArray()}d.call([{methodname:"format_tiles_get_section_information",args:{courseid:e,sectionnums:c}}]).forEach(function(c){c.then(function(c){c.sections.forEach(function(c){var d=a(i.tileId+c.sectionnum);if(c.isavailable&&d.hasClass("tile-restricted")){d.removeClass("tile-restricted")}else if(!c.isavailable){d.addClass("tile-restricted")}if(c.isclickable&&!d.hasClass("tile-clickable")){d.addClass("tile-clickable")}else if(!c.isclickable&&d.hasClass("tile-clickable")){d.removeClass("tile-clickable")}var e=a(i.progressIndicatorId+c.sectionnum);if(e.attr("data-numcomplete")!==void 0&&e.attr("data-numcomplete")!==c.numcomplete.toString()){b.render("format_tiles/progress",l(c.sectionnum,c.numcomplete,c.numoutof,e.hasClass("percent"))).done(function(b){e.replaceWith(b);if(g){try{a(i.progressIndicatorId+c.sectionnum).tooltip()}catch(a){require(["core/log"],function(b){b.debug(a)})}}})}var f=d.find(i.availabilityinfo);if(0<f.length&&c.isavailable&&!c.availabilitymessage){f.fadeOut()}else if(!c.isavailable&&c.availabilitymessage){if(0<f.length){f.html="NEW"+c.availabilitymessage;f.fadeIn()}else{b.render("format_tiles/availability_info",{availabilitymessage:c.availabilitymessage,visible:!0}).done(function(b){e.replaceWith(b);if(g){try{a(i.progressIndicatorId+c.sectionnum).tooltip()}catch(a){require(["core/log"],function(b){b.debug(a)})}}})}}})}).catch(function(a){require(["core/log"],function(b){b.debug("Failed to get section information to check completion status of section");b.debug(a)})})})};return{init:function init(b,c,d,h){e=b;g="1"===h;a(document).ready(function(){k=JSON.parse(d);f.completeauto=c;a("body").on("click",i.togglecompletion,function(b){b.preventDefault();n(a(b.currentTarget))});var b=a("#page-content");if(0===b.length){b=a("#region-main")}b.on("click",i.launchModuleModal+", "+i.launchResourceModal,function(b){var c=a(b.currentTarget).closest(i.activity);if(c.hasClass("completeonview")){o(c)}});a(i.pageContent).on("click",i.completeonevent+", "+i.completeonview,function(b){var c=a(b.currentTarget).closest(i.section).attr("data-section");require(["format_tiles/browser_storage"],function(a){a.storeCourseContent(e,c,"")})})})},markAsAutoCompleteInUI:function markAsAutoCompleteInUI(a,b){e=a;o(b)},updateTileInformation:function updateTileInformation(a){try{p(a)}catch(a){require(["core/log"],function(b){b.debug(a)})}}}});
//# sourceMappingURL=completion.min.js.map
